---
title: "Social Equity, Access and the New York School System"
author: "Kunal Kerai"
date: "August 29, 2018"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background and Problem Statement
PASSNYC -- a not-for-profit organization that facilitates a collective impact-- is dedicated to broadening educational opportunities for New York City's talented and underserved students. New York City is home to some of the most impressive educational institutions in the world, yet in recent years, the City's specialized high schools - institutions with historically transformative impact on student outcomes - have seen a shift toward more homogeneous student body demographics.

PASSNYC uses public data to identify students within New York City's under-performing school districts and, through consulting and collaboration with partners, aims to increase the diversity of students taking the Specialized High School Admissions Test (SHSAT). By focusing efforts in under-performing areas that are historically underrepresented in SHSAT registration, we will help pave the path to specialized high schools for a more diverse group of students.

With limited time and resources, PASSNYC must be strategic in systemically improving the diversity pipeline and social mobility of certain disadvantaged groups into the specialized schools. The main question to be answered is where will PASSNYC's investment produce the greatest ROI for the services they offer (after school programs, test preparation, mentoring, or resources for parents)?

## Data Dictionary

* school: school name	
* DBN: State Education Department Code	
* district	
* lat: lattitude coordinates of school	
* long: longitude coordinates of school 	
* address: full address of school	
* City	
* zip	
* commSchool: Is the school a community school (Y/N)?
* eni	income: (%temp housing) + (% HRA eligible x 0.5) + (% free lunch eligible x 0.5). The higher the index, the higher the need.
* pctELL: percent of English Language Learners


* Race Percentages: percent of school that identifies as a certain race. 
    + pctAsian
    + pctBlack
    + pctHispanic
    + pctBlackHispanic:  percent of Black students + percent of Hispanic students
    + pctWhite: White
    
  
* Attendance
    + pctAttend: total number of days attended by all students / total number of days on register for all students	
    + pctAbsentChronic: percent of students missing 10% of school days - or 18 days+ per year in a 180-day school year


* Psychosocial Ratings
    + pctRigor: How well the curriculum and instruction engage students, build critical-thinking skills, and are aligned to the Common Core
    + ratingRigor: How well the curriculum and instruction engage students, build critical-thinking skills, and are aligned to the Common Core
    + pctCollab: How well teachers participate in opportunities to develop, grow, and contribute to the continuous improvement of the school community  
    + ratingCollab: How well teachers participate in opportunities to develop, grow, and contribute to the continuous improvement of the school community
    + pctSupp: How well the school establishes a culture where students feel safe, challenged to grow, and supported to meet high expectations
    + ratingSupp: How well the school establishes a culture where students feel safe, challenged to grow, and supported to meet high expectations 	
    + pctLeader: How well school leadership inspires the school community with a clear instructional vision and effectively distributes leadership to realize this vision	
    + ratingLeader: How well school leadership inspires the school community with a clear instructional vision and effectively distributes leadership to realize this vision	
    + pctCommunity: How well the school forms effective partnerships with families to improve the school	
    + ratingCommunity: How well the school forms effective partnerships with families to improve the school
    + pctTrust: Whether the relationships between administrators, educators, students, and families are based on trust and respect
    + ratingTrust: Whether the relationships between administrators, educators, students, and families are based on trust and respect

* Average School Scores for English (ELA) and Math sections
    + avgELA
    + avgMath

* Students and test statistics for District 5/6
    + enroll: number of students enrolled in the school
    + registered: number of students who registered for SHSAT
    + took: number of students who took the SHSAT
    + regPct: registered/enroll
    + tookPct: took/enroll
    + yield: took/registered
    
* Numeric values for psychosocial categories (0= NA, 1= Not Meeting Expectations, 2= Approaching Expectations, 3= Meeting Expectations, 4= Exceeeding Expectations))    
    + quantCollab
    + quantSupp
    + quantRigor
    + quantLeader
    + quantCommunity
    + quantTrust


## Data Cleaning

### Loading Libraries and Data
Let's load some libraries we will use.
```{r}
library(tidyverse)
library(ggplot2)
library(corrplot)
source("http://www.sthda.com/upload/rquery_cormat.r")
```


Let's load our data from the table:
```{r message=FALSE, warning=FALSE, include= T , paged.print= F}
reg <- read_csv("D5 SHSAT Registrations and Testers.csv")
school <- read_csv("2016 School Explorer.csv")
```

Before we proceed, let's take a look at the initial data.
```{r message=FALSE, warning=FALSE, include= T , paged.print= F}
head(reg)

head(school)
```

Our data looks pretty clean by most standards, but there is work to be done for sure. For example, we'll need to rename some of our variable names, join our two tables, etc. Let's move forward with some cleaning.
 
In order to make our data analysis easier, let's start cleaning the data. Let's begin by focusing on `reg`.

### Reg
We begin by renaming the columns we plan to use.


```{r include=FALSE}

reg<- reg %>%
  rename(school = `School name`,
         year = `Year of SHST`,
         grade = `Grade level`,
         enroll = `Enrollment on 10/31`,
         registered = `Number of students who registered for the SHSAT`,
         took = `Number of students who took the SHSAT`)

#Finding the average number of students at each school, how many registered, and how many took the test
reg<- reg %>%
  group_by(school) %>%
  mutate_if(is.numeric, mean) %>%
  mutate_if(is.character, funs(paste(unique(.), collapse = "_"))) %>%
  distinct()

#Changing the case will let us match and eventually join the tables.
reg$school<-toupper(reg$school)

#Let's remove some columns that have no use for our future analysis.
reg<-reg %>%
  select(-year )%>%
  select(-grade)


#Calculating percentages of those who registered of the total population, registered AND took the test, and those who took the test of the total population
reg<-reg%>%
  mutate(regPct = registered/enroll)%>%
  mutate(tookPct = took/enroll)%>%
  mutate(yield = took/registered)


#What does the table currently look like?
str(reg)


#Let's clean up the other sheet
school<-read_csv("2016 School Explorer.csv")

#what does the table look like?
str(school)

#renaming some columns
head(school)

school<- school %>%
  rename(school = `School Name`,
         address = `Address (Full)`,
         DBN = `Location Code`, 
         lat =  Latitude,
         long = Longitude,
         zip = Zip,
         eni = `Economic Need Index`,
         district = District,
         commSchool = `Community School?`,
         income = `School Income Estimate`,
         pctELL = `Percent ELL`,
         pctAsian = `Percent Asian`,
         pctBlack = `Percent Black`,
         pctBlackHispanic = `Percent Black / Hispanic`,
         pctHispanic = `Percent Hispanic`,
         pctWhite = `Percent White`,
         pctAttend = `Student Attendance Rate`,
         pctAbsentChronic = `Percent of Students Chronically Absent`,
         pctRigor = `Rigorous Instruction %`,
         ratingRigor = `Rigorous Instruction Rating`,
         pctCollab = `Collaborative Teachers %`,
         ratingCollab = `Collaborative Teachers Rating`,
         pctSupp = `Supportive Environment %`,
         ratingSupp = `Supportive Environment Rating`,
         pctLeader = `Effective School Leadership %`,
         ratingLeader = `Effective School Leadership Rating`,
         pctCommunity = `Strong Family-Community Ties %`,
         ratingCommunity = `Strong Family-Community Ties Rating`,
         pctTrust = `Trust %`,
         ratingTrust = `Trust Rating`,
         avgELA = `Average ELA Proficiency`,
         avgMath = `Average Math Proficiency`,
         mathAll = `Grade 8 Math - All Students Tested`,
         mathAll4 = `Grade 8 Math 4s - All Students`,
         mathBlack = `Grade 8 Math 4s - Black or African American`,
         mathHispanic = `Grade 8 Math 4s - Hispanic or Latino`,
         mathAsian = `Grade 8 Math 4s - Asian or Pacific Islander`,
         mathWhite = `Grade 8 Math 4s - White`,
         elaAll = `Grade 8 ELA - All Students Tested`,
         elaAll4 = `Grade 8 ELA 4s - All Students`,
         elaBlack = `Grade 8 ELA 4s - Black or African American`,
         elaHispanic = `Grade 8 ELA 4s - Hispanic or Latino`,
         elaAsian = `Grade 8 ELA 4s - Asian or Pacific Islander`,
         elaWhite = `Grade 8 ELA 4s - White` )

 
#remove unneccessary columns
school<-school%>%
  select(-`Adjusted Grade`)%>%
  select(-`New?`)%>%
  select(-`Other Location Code in LCGMS`)%>%
  select(-`SED Code`)%>%
  select(-starts_with('Grade'))        

#now we want to join the tables together
school_clean <- full_join(school, reg, by = "DBN" )

#changing some columns to numeric values (as they should be)

school_clean<- school_clean %>% 
  mutate_at(vars(contains('pct')),funs(as.numeric(gsub("%", "", ., fixed = TRUE))/100)) %>%
  mutate(income = as.numeric(gsub('\\$|,', '', income))) %>%
  mutate(eni = as.numeric(eni))%>%
  mutate(avgELA = as.numeric(avgELA),
         avgMath = as.numeric(avgMath),
         academicScore = avgMath + avgELA)



#making some final touches on our new table
school_clean <- school_clean%>%
  filter(!is.na(school.x))%>%
  select(-school.y)%>%
  rename(school = school.x)

#let's turn some qualitative ratings into quantitative scores. First, let's create a function to make creating these new columns easier.
quantScore <- function(x){
  if_else(grepl("Not Meeting Target", x),1 ,
          if_else(grepl("Approaching Target", x),2 ,
                  if_else(grepl("Meeting Target", x),3 , 
                          if_else(grepl("Exceeding Target", x), 4, 0))))
  
}

school_clean<- school_clean%>%
  mutate(quantRigor = quantScore(ratingRigor)) %>%
  mutate(quantCollab = quantScore(ratingCollab)) %>%
  mutate(quantSupp = quantScore(ratingSupp)) %>%
  mutate(quantLeader = quantScore(ratingLeader)) %>%
  mutate(quantCommunity = quantScore(ratingCommunity)) %>%
  mutate(quantTrust = quantScore(ratingTrust))


school_clean <- school_clean%>%
  mutate(pctELA4 = elaAll4 / elaAll,
          pctELABlack = elaBlack / elaAll4,
          pctELAHispanic = elaHispanic / elaAll4,
          pctELAAsian = elaAsian / elaAll4,
          pctELAWhite = elaWhite/ elaAll4,
          pctMath4 = mathAll4 / mathAll4,
          pctMathBlack = mathBlack / mathAll4,
          pctMathHispanic = mathHispanic / mathAll4,
          pctMathAsian = mathAsian / mathAll4,
          pctMathWhite = mathWhite / mathAll4)
          

write_csv(school_clean, "SHSAT_data.csv")


str(school_clean)

         
```         



Before continuing, there are three things we need to consider when analyzing our data:

* PassNYC cares about increasing diversity; therefore need to look at low income, and underrepresented racial minorities (URM) students
* PassNYC wants to improve the situation through their offerings: after school programs, test preparation, mentoring, and resources for parents
* Success will be measured by how many student register then take the test, as well as the academic performance of the school as an indicator.

We consider a school to be economically stratified if its economic need as measured by the Economic
Need Index1 is more than 10 percentage points from the citywide average. A school can be stratified in either direction - by serving more low-income or more high-income children. New York City reports that 70.6% of schools are economically stratified today. 





## Exploratory Data Analysis
```{r echo=F, message=FALSE, warning=FALSE, paged.print=TRUE}


race<-gather(school_clean, race, percent, pctAsian:pctWhite, factor_key=TRUE)

head(race)

#Racial Demographic Distribution
ggplot(race, aes(x = percent, fill = race)) +
  geom_density() +
  facet_grid(race ~ .) +
  labs(title="Distributions of Students by Race")

#Heatmap of ENI
eniMap <- get_map(location = "New York City", zoom= 11, maptype = "terrain", source="google")
ggmap(eniMap) +
  stat_summary_2d(geom = "tile",bins = 35, data=race, aes(x = long, y = lat, z = eni), alpha=0.5) +
  scale_fill_gradient(low = "green", high = "red", guide = guide_legend(title = "ENI")) +
  xlab("") + ylab("")

#Heatmap of Race
raceMap <- get_map(location = "New York City", zoom= 11, maptype = "terrain", source="google")
ggmap(raceMap) +
  stat_summary_2d(geom = "tile",bins = 50, data=race, aes(x = long, y = lat, z = percent), alpha=0.5) +
  scale_fill_gradient(low = "green", high = "red", guide = guide_legend(title = "Density")) +
  xlab("") + ylab("") +
  facet_wrap(~ race)



#We can use avgMath because it is multicollinear with avgELA.

ggplot(school_clean, aes(eni, academicScore)) +
  geom_point() + 
  stat_smooth(method = "lm") +
  labs(title="As ENI increases, scores decrease.", 
       x= "ENI",
       y="Aggregate ELA and Math Scores")
```

Based on the information below, we can see the overall distributions of each race within the NYC school districts.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}


toBeRemoved<-which(race$race=="pctBlackHispanic")
raceWithoutURM <-race[-toBeRemoved,]

ggplot(raceWithoutURM, aes( x = as.factor(district), fill = race)) + 
  geom_bar() + 
  labs(title="Racial Breakdown per District", 
       x= "District",
       y = "Number of Students")


```

##Examining Academic Performance
```{r}
score<-gather(school_clean, race, count, c(elaBlack, elaHispanic ), factor_key=TRUE)
score<-score%>%
  filter(!is.na(count) & count>0)

score

score%>%
  group_by(school)%>%
  filter(countScale>1)%>%
  summarise(count = sum(count))

score$countScale<- scale(score$count)


#Racial Demographic Distribution
ggplot(score, aes(x = percent, fill = race)) +
  geom_density() +
  facet_grid(race ~ .) +
  labs(title="Distributions of Students by Race")

eniMap <- get_map(location = "New York City", zoom= 11, maptype = "terrain", source="google")
ggmap(eniMap) +
  stat_summary_2d(geom = "tile",bins = 35, data=score, aes(x = long, y = lat, z = count), alpha=0.5) +
  scale_fill_gradient(low = "yellow", high = "green", guide = guide_legend(title = "Density of 4 Scores")) +
  xlab("") + ylab("")


```


## Examining our Hi-Potential diverse schools
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
ggplot(school_clean, aes(pctHispanic, avgMath)) +
  geom_point(col = ifelse(school_clean$avgMath > 3.0 & school_clean$pctHispanic>.50, "red", "black"))

Hispanic <- school_clean%>%
  filter(avgMath >=3.0)%>%
  filter(pctHispanic>=.5)
Hispanic

ggplot(school_clean, aes(pctBlack, avgMath)) +
  geom_point(col = ifelse(school_clean$avgMath > 3.0 & school_clean$pctBlack>.50, "red", "black"))


Black <- school_clean%>%
  filter(avgMath >=3.0)%>%
  filter(pctBlack>=.5)


hipo <- bind_rows(Hispanic, Black)
hipo

ggplot(hipo, aes(x = as.factor(district), y= avgMath)) +
  geom_violin() +
   labs(title="What Districts have the highest diversity and average scores?", 
       x= "District",
       y="Average Math Scores")

ggplot(hipo, aes(district)) +
  geom_bar(stat = "bin")

ggplot(hipo, aes(pctBlackHispanic, avgMath)) + geom_point() +stat_smooth(method = "lm")

hipo

```
When examining the hi-po population, we can see that Districts 4,5,7,8,9,11,23,24, and 27 have hi-po students.


## Correlation Matrix
```{r}
numeric<- na.omit(school_clean)

numeric%>%
  select(eni, income, yield, enroll, regPct, tookPct, starts_with('pct'), starts_with('avg'), starts_with('quant'))%>%
  cor() %>%
  corrplot(type = "upper", method = "square")  

```

